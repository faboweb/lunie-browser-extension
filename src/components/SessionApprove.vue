<template>
  <div class="session-approve">
    <h2>Approve Transaction</h2>
    <br />
    <div class="from">
      From
      <Address :address="senderAddress" />
    </div>
    <TmFormGroup v-if="signRequest">
      <TransactionItem
        v-if="transaction"
        :key="transaction.key"
        :transaction="transaction"
        :validators="validatorsAddressMap"
        :address="senderAddress"
        :show-meta-data="false"
      />
      <!-- Going to take some more logic based on how transactions are passed in -->
      <TableInvoice
        class="approval-table"
        :amount="amount"
        :estimated-fee="fees"
        :bond-denom="bondDenom"
      />
      <TmFormGroup
        :error="$v.password.$error && $v.password.$invalid"
        class="action-modal-group"
        field-id="password"
        field-label="Password"
      >
        <TmField
          id="password"
          v-model="password"
          v-focus
          type="password"
          placeholder="Password"
        />
        <TmFormMsg
          v-if="$v.password.$error && !$v.password.required"
          name="Password"
          type="required"
        />
        <TmFormMsg
          v-if="$v.password.$error && !$v.password.passwordCorrect"
          name="Password"
          type="custom"
          msg="is incorrect"
        />
      </TmFormGroup>

      <div class="session-approve-footer">
        <TmBtn
          id="reject-btn"
          value="Reject"
          class="left-button"
          type="secondary"
          @click.native="reject"
        />
        <TmBtn
          id="approve-btn"
          value="Approve"
          class="right-button"
          type="primary"
          @click.native="approve"
        />
      </div>
    </TmFormGroup>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'
import TmBtn from 'common/TmBtn'
import TmFormGroup from 'common/TmFormGroup'
import TmField from 'common/TmField'
import TmFormMsg from 'common/TmFormMsg'
import TransactionItem from 'transactions/TransactionItem'
import TableInvoice from 'src/ActionModal/components/TableInvoice'
import Address from 'common/Address'
import { required } from 'vuelidate/lib/validators'
import { parseTx, parseFee, parseValueObj } from '../scripts/parsers.js'
import { atoms } from 'scripts/num.js'
import actions from '../store/actions.js'

const getValidatorsData = actions({}).getValidatorsData

import { flattenTransactionMsgs } from 'scripts/transaction-utils'

const getWithdrawValidators = messages => {
  const withdrawMessages = messages.filter(({ type }) => {
    const messageSuffix = type.split('/')[1]
    return messageSuffix === 'MsgWithdrawDelegationReward'
  })

  // strange syntax where we actually return the whole message instead of just the validator
  return withdrawMessages
}

const getLunieTransaction = tx => {
  const lunieTransactions = flattenTransactionMsgs([], tx)
  const pickFirst = lunieTransactions[0] // obviously error prone as we ignore the rest
  pickFirst.withdrawValidators = JSON.stringify(
    getWithdrawValidators(lunieTransactions)
  )

  return pickFirst
}

export default {
  name: `session-approve`,
  components: {
    TmBtn,
    TmFormGroup,
    TransactionItem,
    TableInvoice,
    Address,
    TmField,
    TmFormMsg
  },
  data: () => ({
    validators: [],
    password: null,
    passwordError: false
  }),
  computed: {
    ...mapGetters(['signRequest']),
    tx() {
      return this.signRequest ? parseTx(this.signRequest.signMessage) : null
    },
    network() {
      return this.signRequest ? this.signRequest.network : null
    },
    transaction() {
      return getLunieTransaction(this.tx)
    },
    fees() {
      return this.tx ? atoms(parseFee(this.tx.tx)) : null
    },
    senderAddress() {
      return this.signRequest ? this.signRequest.senderAddress : null
    },
    amountCoin() {
      return this.tx ? parseValueObj(this.tx.tx) : null
    },
    amount() {
      return this.amountCoin ? atoms(Number(this.amountCoin.amount)) : 0
    },
    bondDenom() {
      return this.amountCoin ? this.amountCoin.denom : ''
    },
    validatorsAddressMap() {
      const names = {}
      this.validators.forEach(item => {
        names[item.operator_address] = item
      })
      return names
    }
  },
  watch: {
    password: function() {
      this.passwordError = false
    }
  },
  async mounted() {
    const validatorsObject = await getValidatorsData(this.tx.tx, this.network)
    this.validators = validatorsObject
  },
  methods: {
    isValidInput(property) {
      this.$v[property].$touch()

      return !this.$v[property].$invalid
    },
    async approve() {
      if (this.isValidInput('password')) {
        await this.$store
          .dispatch('approveSignRequest', {
            ...this.signRequest,
            password: this.password
          })
          .catch(e => {
            if (e === 'Incorrect password') {
              this.passwordError = true
            }
            return
          })
        this.$router.push(`/success`)
      }
    },
    async reject() {
      await this.$store.dispatch('rejectSignRequest', {
        ...this.signRequest
      })
      window.close()
    },
    correctPassword() {
      return !this.passwordError
    }
  },
  validations() {
    const passwordCorrect = this.correctPassword
    return {
      password: {
        required,
        passwordCorrect
      }
    }
  }
}
</script>

<style scoped>
.session-approve {
  padding: 2rem;
  background: var(--fg);
  border-left: 1px solid var(--bc-dim);
}

.session-approve h2 {
  color: var(--bright);
  font-size: var(--h1);
  font-weight: 500;
  line-height: 3rem;
}

.card {
  background: var(--app-nav);
  border-radius: 2px;
  padding: 1rem;
  font-size: var(--m);
  margin-bottom: 0.5rem;
  border: 1px solid var(--bc);
}

.card h3 {
  font-size: 14px;
  font-weight: 400;
}

.content-left {
  display: flex;
  flex-direction: column;
}

.session-approve-footer {
  display: flex;
  justify-content: flex-end;
  padding: 2rem 0 0;

  /* keeps button in bottom right no matter the size of the action modal */
  flex-grow: 1;
}

.from {
  font-size: 14px;
}

.left-button {
  margin-right: 0.5rem;
}
</style>

<style>
.approval-table .table-invoice {
  padding: 0.5rem 0;
  margin: 1rem 0;
  font-size: 14px;
}
</style>
